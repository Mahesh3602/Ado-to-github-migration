name: "1. Migrate Repo & Export Mannequins"

on:
  workflow_dispatch:
    inputs:
      ado_repo_url:
        description: 'Azure DevOps Repo URL'
        required: true
      github_repo_name:
        description: 'New GitHub Repo Name'
        required: true

jobs:
  migration_job:
    runs-on: ubuntu-latest
    env:
      # Secrets mapped to Env Variables
      GH_PAT: ${{ secrets.GH_PAT }}
      ADO_PAT: ${{ secrets.ADO_PAT }}
      GITHUB_ORG_NAME: ${{ secrets.ORG_NAME }}
      ADO_REPO_URL: ${{ github.event.inputs.ado_repo_url }}
      GIT_REPO_NAME: ${{ github.event.inputs.github_repo_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: üîë Grant Permissions
        run: chmod +x scripts/*.sh

      - name: üõ†Ô∏è Get Org & Source IDs
        id: ids
        run: |
          # Fetch Org ID and filter out non-JSON text
          ORG_RAW=$(./scripts/01-get_org_id.sh)
          ORG_ID=$(echo "$ORG_RAW" | grep -o '{.*}' | jq -r '.data.organization.id // empty')
          
          # Fetch Source ID and filter out non-JSON text
          SOURCE_RAW=$(./scripts/02-create_migration_source_id.sh)
          SOURCE_ID=$(echo "$SOURCE_RAW" | grep -o '{.*}' | jq -r '.data.createMigrationSource.migrationSource.id // empty')

          # Validation
          if [ -z "$ORG_ID" ]; then echo "‚ùå Failed to capture ORG_ID"; exit 1; fi
          if [ -z "$SOURCE_ID" ]; then echo "‚ùå Failed to capture SOURCE_ID"; exit 1; fi

          # Export to Environment
          echo "ORG_ID=$ORG_ID" >> $GITHUB_ENV
          echo "SOURCE_ID=$SOURCE_ID" >> $GITHUB_ENV
          echo "‚úÖ IDs Captured: Org=$ORG_ID, Source=$SOURCE_ID"

      - name: üöÄ Start Migration
        run: |
          # Run script and save output
          ./scripts/03-start_migrate_repo.sh > migration_output.json
          
          # Extract Migration ID (RM_...)
          RM_ID=$(cat migration_output.json | grep -o '{.*}' | jq -r '.data.startRepositoryMigration.repositoryMigration.id // empty')
          
          if [ -z "$RM_ID" ]; then 
            echo "‚ùå Migration failed to start. Output:"
            cat migration_output.json
            exit 1
          fi

          echo "MIGRATION_ID=$RM_ID" >> $GITHUB_ENV
          echo "üöÄ Migration Started: $RM_ID"

      - name: ‚è≥ Wait for Completion
        run: |
          STATUS="QUEUED"
          while [[ "$STATUS" != "SUCCEEDED" && "$STATUS" != "FAILED" ]]; do
            # We use the MIGRATION_ID exported in the previous step
            RESPONSE=$(./scripts/04-check_status.sh)
            STATUS=$(echo "$RESPONSE" | grep -o '{.*}' | jq -r '.state')
            
            echo "Current Status: $STATUS"
            if [ "$STATUS" == "FAILED" ]; then 
              echo "‚ùå Migration Failed!"
              exit 1
            fi
            
            if [ "$STATUS" != "SUCCEEDED" ]; then
              echo "Waiting 30 seconds..."
              sleep 30
            fi
          done
          echo "‚úÖ Migration Succeeded!"

      - name: üîç Generate Mannequin CSV
        run: |
          pip install requests
          # This script will now use GITHUB_ORG_NAME from the env
          python3 scripts/05-generate_mannequins.py

      - name: üì§ Upload CSV for Manual Edit
        uses: actions/upload-artifact@v4
        with:
          name: mannequins-to-edit
          path: mannequins.csv
