name: "1. Migrate Repo & Export Mannequins"

on:
  workflow_dispatch:
    inputs:
      ado_repo_url:
        description: 'Azure DevOps Repo URL'
        required: true
      github_repo_name:
        description: 'New GitHub Repo Name'
        required: true

jobs:
  migration_job:
    runs-on: ubuntu-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      ADO_PAT: ${{ secrets.ADO_PAT }}
      GITHUB_ORG_NAME: ${{ secrets.ORG_NAME }}
      ADO_REPO_URL: ${{ github.event.inputs.ado_repo_url }}
      GIT_REPO_NAME: ${{ github.event.inputs.github_repo_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: üîë Grant Permissions
        run: chmod +x scripts/*.sh

      - name: üõ†Ô∏è Get Org & Source IDs
        run: |
          # Extract Org ID
          ORG_ID=$(./scripts/01-get_org_id.sh | grep -o '{.*}' | jq -r '.data.organization.id // empty')
          
          # Extract Source ID
          SOURCE_ID=$(./scripts/02-create_migration_source_id.sh | grep -o '{.*}' | jq -r '.data.createMigrationSource.migrationSource.id // empty')

          # Strict Validation
          if [[ -z "$ORG_ID" || "$ORG_ID" == "null" ]]; then echo "‚ùå Failed to capture ORG_ID"; exit 1; fi
          if [[ -z "$SOURCE_ID" || "$SOURCE_ID" == "null" ]]; then echo "‚ùå Failed to capture SOURCE_ID"; exit 1; fi

          echo "ORG_ID=$ORG_ID" >> $GITHUB_ENV
          echo "SOURCE_ID=$SOURCE_ID" >> $GITHUB_ENV

      - name: üöÄ Start Migration
        run: |
          ./scripts/03-start_migrate_repo.sh > migration_output.json
          
          RM_ID=$(cat migration_output.json | grep -o '{.*}' | jq -r '.data.startRepositoryMigration.repositoryMigration.id // empty')
          
          if [[ -z "$RM_ID" || "$RM_ID" == "null" ]]; then
            echo "‚ùå Migration failed to start. API Response:"
            cat migration_output.json
            exit 1
          fi

          echo "MIGRATION_ID=$RM_ID" >> $GITHUB_ENV
          echo "üöÄ Migration Started: $RM_ID"

      - name: ‚è≥ Wait for Completion
        run: |
          STATUS="QUEUED"
          while [[ "$STATUS" != "SUCCEEDED" && "$STATUS" != "FAILED" ]]; do
            RESPONSE=$(./scripts/04-check_status.sh)
            STATUS=$(echo "$RESPONSE" | grep -o '{.*}' | jq -r '.state // .data.node.state')
            
            echo "Current Status: $STATUS"
            if [ "$STATUS" == "FAILED" ]; then 
              echo "‚ùå Migration Failed!"
              exit 1
            fi
            
            if [ "$STATUS" != "SUCCEEDED" ]; then
              sleep 30
            fi
          done
          echo "‚úÖ Migration Succeeded!"

      - name: üîç Generate Mannequin CSV
        run: |
          pip install requests
          python3 scripts/05-generate_mannequins.py

      - name: üì§ Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: mannequins-to-edit
          path: mannequins.csv
