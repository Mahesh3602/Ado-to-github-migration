name: "1. Migrate Repo & Export Mannequins"

on:
  workflow_dispatch:
    inputs:
      ado_repo_url:
        description: 'Azure DevOps Repo URL'
        required: true
      github_repo_name:
        description: 'New GitHub Repo Name'
        required: true

jobs:
  migration_job:
    runs-on: ubuntu-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      ADO_PAT: ${{ secrets.ADO_PAT }}
      GITHUB_ORG_NAME: ${{ secrets.ORG_NAME }}
      ADO_REPO_URL: ${{ github.event.inputs.ado_repo_url }}
      GIT_REPO_NAME: ${{ github.event.inputs.github_repo_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name:  Grant Permissions
        run: chmod +x scripts/*.sh

      - name: Get Organization ID
        run: |
          ORG_JSON=$(./scripts/01-get_org_id.sh)
          ORG_ID=$(echo "$ORG_JSON" | jq -r '.data.organization.id // empty')
          
          if [[ -z "$ORG_ID" || "$ORG_ID" == "null" ]]; then
            echo "❌ Error: Could not resolve Organization ID."
            echo "API Response: $ORG_JSON"
            exit 1
          fi
          echo "ORG_ID=$ORG_ID" >> $GITHUB_ENV
          echo "✅ Found ORG_ID: $ORG_ID"

      - name: Create Migration Source
        run: |
          SOURCE_JSON=$(./scripts/02-create_migration_source_id.sh)
          SOURCE_ID=$(echo "$SOURCE_JSON" | jq -r '.data.createMigrationSource.migrationSource.id // empty')

          if [[ -z "$SOURCE_ID" || "$SOURCE_ID" == "null" ]]; then
            echo "❌ Error: Failed to create Migration Source."
            echo "API Response: $SOURCE_JSON"
            exit 1
          fi
          echo "SOURCE_ID=$SOURCE_ID" >> $GITHUB_ENV
          echo "✅ Created SOURCE_ID: $SOURCE_ID"

      - name: Start Migration
        run: |
          ./scripts/03-start_migrate_repo.sh > migration_output.json
          RM_ID=$(cat migration_output.json | jq -r '.data.startRepositoryMigration.repositoryMigration.id // empty')
          
          if [[ -z "$RM_ID" || "$RM_ID" == "null" ]]; then
            echo "❌ Migration failed to start."
            cat migration_output.json
            exit 1
          fi
          echo "MIGRATION_ID=$RM_ID" >> $GITHUB_ENV
          echo "✅ Migration Started: $RM_ID"

      - name: Wait for Completion
        run: |
          STATUS="QUEUED"
          while [[ "$STATUS" != "SUCCEEDED" && "$STATUS" != "FAILED" ]]; do
            RESPONSE=$(./scripts/04-check_status.sh)
            # Capture both status and reason
            STATUS=$(echo "$RESPONSE" | jq -r '.data.node.state')
            REASON=$(echo "$RESPONSE" | jq -r '.data.node.failureReason // "No reason provided"')
            
            echo "Current Status: $STATUS"
            
            if [[ "$STATUS" == "FAILED" ]]; then 
              echo "❌ Migration Failed!"
              echo "Reason: $REASON"
              exit 1
            fi
            
            [[ "$STATUS" != "SUCCEEDED" ]] && sleep 30
          done
          echo "✅ Migration Succeeded!"

      - name: Generate Mannequin CSV
        run: |
          pip install requests
          python3 scripts/05-generate_mannequins.py

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: mannequins-to-edit
          path: mannequins.csv

